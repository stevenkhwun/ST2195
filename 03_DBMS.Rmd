---
title: "Introduction to Relational Database Management Systems"
date: "2023/7/22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Creating and Manipulating Databases in R Using `DBI`

## Connecting to Databases

`DBI` is a library which is included in the package `RSQLite`. The package could be installed by the following code:

```{r eval=FALSE}
# the code is not executed as the package has already been installed
install.packages("RSQLite")
```

And then we load the required library `DBI`:
```{r}
# load the required library
library(DBI)
```

We then use the function `dbConnect()` to create an object, `conn`, to connect to the SQLite driver to manipulate the database `university.db`. Before that, we need to check whether the database `university.db` exists. If the database `university.db` exists, the following code chunk will remove it.

```{r results='hide'}
# delete "university.db" if already exists
if (file.exists("university.db"))
  file.remove("university.db")
```

We use `dbConnect()` to connect to the database:
```{r}
conn <- dbConnect(RSQLite::SQLite(), "university.db")
```

We can list all tables in `university.db` using the function `dbListTable()` from `DBI`.

```{r}
# list all table
dbListTables(conn)
```

Nothing is returned because we have not created any tables in the database yet.

## Creating Tables

We are going to create some tables to the database `university.db`. We will create the tables using data saved in the CSV files. We first read the CSV files into `data.frame` in R:

```{r}
# read the CSV files into data.frame in R
course <- read.csv("Course Files/Block 3/course.csv", header = TRUE)
student <- read.csv("Course Files/Block 3/student.csv", header = TRUE)
grade <- read.csv("Course Files/Block 3/grade.csv", header = TRUE)
```

We then copy the data frames `student`, `grade` and `course` to tables in the database `university.db` using `DBI`â€™s `dbWriteTable()` function:

```{r}
dbWriteTable(conn, "Course", course)
dbWriteTable(conn, "Student", student)
dbWriteTable(conn, "Grade", grade)
```

Now we can see there are three tables in the database:

```{r}
# list all tables
dbListTables(conn)
```

We can also browse any table in the database using the function `dbReadTable()` from `DBI`.

```{r}
# browse the table
dbReadTable(conn, "Student")
```

Or we can see the attributes of a table (e.g. `Student`) by the function `dbListFields()`:

```{r}
# browse the attributes of a table
dbListFields(conn, "Student")
```

## Manipulating Databases

The simplest way to manipulate databases is to use the `dbExecute()` function. This function executes SQL statements and returns the number of rows affected.

### Adding a New Table

We can add a new table by using the function `dbCreateTable()`. Alternatively, you can use `dbExecute()` to run the SQL command to create a new table.

```{r}
# add a new table using dbCreateTable() function
dbCreateTable(conn, "Teacher", c(staff_id = "TEXT", name = "TEXT"))
```

Alternatively

```{r results='hide'}
# add a new table using dbExecute() function
dbExecute(conn,
          "CREATE TABLE Other_Staff (
          staff_id TEXT PRIMARY KEY,
          name TEXT)")
```

List of tables after adding:

```{r}
# list all tables
dbListTables(conn)
```

### Deleting a Table

We can remove a table by using the function `dbRemoveTable()`:

```{r}
# delete a table using dbRemoveTable() function
dbRemoveTable(conn, "Teacher")
```

Alternatively, we can use `dbExecute()` function:

```{r results='hide'}
# delete a table using dbExecute() function
dbExecute(conn,
          "DROP TABLE Other_Staff")
```

When we list the tables, we can now see three tables.

```{r}
# list all tables
dbListTables(conn)
```






